{% extends "base.html" %}
{% set active = 'users' %}
{% block content %}
<h1 class="h3 mb-4 text-gray-800">User Management</h1>

<div class="row">
  <div class="col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Add user</h6></div>
      <div class="card-body">
        <div class="form-group">
          <label>Username</label>
          <input id="uName" class="form-control" placeholder="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="uPass" class="form-control" placeholder="password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="uRole" class="form-control">
            <option value="user">user</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addUser()">Add</button>
        <div class="mt-3" id="userMsg"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card shadow mb-4">
      <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Users</h6></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.role }}</td>
                <td>{{ u.created_at }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-secondary" onclick="resetPw({{u.id}}, '{{u.username}}')">Reset PW</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="delUser({{u.id}}, '{{u.username}}')">Delete</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="small text-muted mb-0">Note: deleting the initial admin username is blocked.</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function api(url, body){
  const res = await fetch(url, {method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body)});
  return res.json();
}
function msgOk(t){
  const m = document.getElementById("userMsg");
  m.className="alert alert-success py-2"; m.innerText=t;
}
function msgErr(t){
  const m = document.getElementById("userMsg");
  m.className="alert alert-danger py-2"; m.innerText=t;
}
async function addUser(){
  const username = document.getElementById("uName").value.trim();
  const password = document.getElementById("uPass").value;
  const role = document.getElementById("uRole").value;
  const out = await api("/api/users/add", {username, password, role});
  if(out.ok){ msgOk("User added. Refresh page."); }
  else { msgErr(out.message || "Failed"); }
}
async function delUser(id, username){
  if(!confirm("Delete user "+username+"?")) return;
  const out = await api("/api/users/delete", {id});
  if(out.ok){ msgOk("Deleted. Refresh page."); }
  else { msgErr(out.message || "Failed"); }
}
async function resetPw(id, username){
  const pw = prompt("New password for "+username+":");
  if(!pw) return;
  const out = await api("/api/users/resetpw", {id, password: pw});
  if(out.ok){ msgOk("Password reset."); }
  else { msgErr(out.message || "Failed"); }
}
</script>
{% endblock %}
